<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kerstlichtjes Kleurkiezer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* Custom styling for the color input */
        #colorPicker {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background: none;
            border: none;
            width: 100%;
            height: 150px;
            cursor: pointer;
            border-radius: 1.5rem; 
            padding: 0;
            overflow: hidden;
        }
        #colorPicker::-webkit-color-swatch-wrapper { padding: 0; }
        #colorPicker::-webkit-color-swatch { border: none; border-radius: 1.5rem; }
        #colorPicker::-moz-color-swatch-wrapper { padding: 0; }
        #colorPicker::-moz-color-swatch { border: none; border-radius: 1.5rem; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-md bg-white p-6 md:p-8 rounded-2xl shadow-xl space-y-6">
        <h1 class="text-3xl font-bold text-center text-gray-800">Kleurkiezer voor Kerst</h1>
        <p class="text-center text-gray-500 mb-2">Selecteer een kleur of een speciaal effect.</p>

        <div class="flex flex-col items-center space-y-4">
            <label for="colorPicker" class="text-lg font-medium text-gray-700">Gekozen Kleur:</label>
            <input type="color" id="colorPicker" value="#0056D6">
        </div>

        <div class="space-y-3 pt-2">
            <label class="text-lg font-medium text-gray-700 text-center block">Speciale Effecten:</label>
            <div id="effectButtonsContainer" class="grid grid-cols-5 gap-2 md:gap-3">
                </div>
        </div>

        <div id="statusBox" class="text-center text-sm p-3 rounded-xl font-medium transition-all duration-300 bg-yellow-100 text-yellow-700">
            Verbinden met lampjes...
        </div>

        <button id="publishButton" disabled
                class="w-full py-4 text-lg font-semibold rounded-xl transition duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed
                       bg-blue-600 hover:bg-blue-700 text-white shadow-lg shadow-blue-500/50">
            Kleur aanpassen!
        </button>

        <p class="text-xs text-center text-gray-400 pt-2">
            Broker: test.mosquitto.org (poort 8081, WSS) | Topic: joriskerst
        </p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <script>
        // --- Global MQTT Setup ---
        const host = "test.mosquitto.org";
        const port = 8081;
        const path = ""; 
        const topic = "joriskerst";
        
        // Generate a unique client ID
        const clientId = "web_color_picker_" + Math.random().toString(16).substr(2, 8);
        
        let client;
        
        // ***** NEW: CONFIGURATION FOR EFFECT BUTTONS *****
        // Array of 10 button labels. Payloads will be "1", "2", "3", etc.
        const effectButtonLabels = [
            "Sparkle", "Fade", "Chase", "Blink", "Wave",
            "Cycle", "Strobe", "Twinkle", "Static", "Rainbow"
        ];
        
        // --- DOM Elements ---
        const statusBox = document.getElementById('statusBox');
        const publishButton = document.getElementById('publishButton');
        const colorPicker = document.getElementById('colorPicker');
        const effectButtonsContainer = document.getElementById('effectButtonsContainer'); // NEW

        /**
         * Updates the status message displayed to the user.
         * @param {string} message - The message to display.
         * @param {string} type - The type of message ('info', 'success', 'error').
         */
        function updateStatus(message, type = 'info') {
            statusBox.textContent = message;
            statusBox.classList.remove('bg-yellow-100', 'text-yellow-700', 'bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700');

            // Get all the new effect buttons
            const allEffectButtons = document.querySelectorAll('.effect-button');

            switch (type) {
                case 'success':
                    statusBox.classList.add('bg-green-100', 'text-green-700');
                    publishButton.disabled = false;
                    allEffectButtons.forEach(btn => btn.disabled = false); // Enable
                    break;
                case 'error':
                    statusBox.classList.add('bg-red-100', 'text-red-700');
                    publishButton.disabled = true;
                    allEffectButtons.forEach(btn => btn.disabled = true); // Disable
                    break;
                case 'info':
                default:
                    statusBox.classList.add('bg-yellow-100', 'text-yellow-700');
                    publishButton.disabled = true;
                    allEffectButtons.forEach(btn => btn.disabled = true); // Disable
                    break;
            }
        }
        
        /**
         * ***** NEW: Creates the effect buttons dynamically *****
         */
        function createEffectButtons() {
            effectButtonLabels.forEach((label, index) => {
                const payload = (index + 1).toString(); // Payloads 1-10
                
                const button = document.createElement('button');
                button.type = 'button';
                button.textContent = label;
                button.dataset.payload = payload; // Store payload
                
                // Add classes for styling and selection
                button.className = `effect-button py-2 px-1 text-xs md:text-sm font-medium rounded-lg transition-all 
                                     bg-gray-100 text-gray-700 hover:bg-gray-200 
                                     disabled:opacity-50 disabled:cursor-not-allowed`;
                
                button.disabled = true; // Disabled by default
                
                // Add click listener
                button.addEventListener('click', () => {
                    publishEffect(payload, label);
                });
                
                effectButtonsContainer.appendChild(button);
            });
        }

        /**
         * Connects the Paho MQTT client to the broker.
         */
        function mqttConnect() {
            try {
                client = new Paho.MQTT.Client(host, port, path, clientId);
                client.onConnectionLost = onConnectionLost;
                
                updateStatus("Verbinden met lampjes...");
                client.connect({
                    onSuccess: onConnect,
                    onFailure: onFailure,
                    cleanSession: true,
                    useSSL: true, 
                });
            } catch (e) {
                console.error("MQTT Initialization Error:", e);
                updateStatus(`Fout bij initialisatie: ${e.message}`, 'error');
            }
        }

        /**
         * Called when the connection is established.
         */
        function onConnect() {
            console.log("MQTT Connected");
            updateStatus("Verbinding gelukt! Klaar om te publiceren.", 'success');
        }

        /**
         * Called when the connection fails.
         */
        function onFailure(responseObject) {
            console.error("MQTT Connection Failed:", responseObject);
            updateStatus(`Verbindingsfout: ${responseObject.errorMessage}. Opnieuw proberen in 5s.`, 'error');
            setTimeout(mqttConnect, 5000); 
        }

        /**
         * Called when the connection is lost.
         */
        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.error("MQTT Connection Lost:", responseObject.errorMessage);
                updateStatus(`Verbinding verbroken: ${responseObject.errorMessage}. Opnieuw proberen in 5s.`, 'error');
                setTimeout(mqttConnect, 5000);
            }
        }

        /**
         * Publishes the current color hex value to the MQTT topic.
         */
        function publishColor() {
            if (!client || !client.isConnected()) {
                updateStatus("Niet verbonden. Opnieuw verbinding maken...", 'error');
                mqttConnect(); // Try to reconnect
                return;
            }

            const hexValue = colorPicker.value; 
            const message = new Paho.MQTT.Message(hexValue);
            message.destinationName = topic;
            message.qos = 0;
            message.retained = false; 

            try {
                client.send(message);
                updateStatus(`Kleur (${hexValue}) succesvol verzonden!`, 'success');
                console.log(`Published to ${topic}: ${hexValue}`);

                setTimeout(() => {
                    if (statusBox.textContent.includes("succesvol verzonden")) {
                        updateStatus("Verbinding gelukt! Klaar om te publiceren.", 'success');
                    }
                }, 2000);

            } catch (e) {
                console.error("MQTT Publish Error:", e);
                updateStatus(`Fout bij verzenden: ${e.message}`, 'error');
            }
        }

        /**
         * ***** NEW: Publishes an effect command to the MQTT topic *****
         */
        function publishEffect(payload, buttonText) {
            if (!client || !client.isConnected()) {
                updateStatus("Niet verbonden. Opnieuw verbinding maken...", 'error');
                mqttConnect(); // Try to reconnect
                return;
            }

            // Create the MQTT message
            const message = new Paho.MQTT.Message(payload);
            message.destinationName = topic;
            message.qos = 0; 
            message.retained = false; 

            try {
                client.send(message);
                updateStatus(`Effect (${buttonText}) succesvol verzonden!`, 'success');
                console.log(`Published to ${topic}: ${payload}`);

                // Briefly show success then revert status
                setTimeout(() => {
                    if (statusBox.textContent.includes("succesvol verzonden")) {
                        updateStatus("Verbinding gelukt! Klaar om te publiceren.", 'success');
                    }
                }, 2000);

            } catch (e) {
                console.error("MQTT Publish Error:", e);
                updateStatus(`Fout bij verzenden: ${e.message}`, 'error');
            }
        }

        // --- Event Listeners and Initialization ---
        
        // 1. Initialize the page when it loads
        window.onload = function() {
            createEffectButtons(); // Create the buttons
            mqttConnect();         // THEN connect to MQTT
        };

        // 2. Attach the publish function to the main color button
        publishButton.addEventListener('click', publishColor);

    </script>

</body>
</html>
