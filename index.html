<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kerstlichtjes Kleurkiezer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* Custom styling for the color input */
        #colorPicker {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background: none;
            border: none;
            width: 100%;
            height: 150px;
            cursor: pointer;
            border-radius: 1.5rem;
            padding: 0;
            overflow: hidden;
        }
        #colorPicker::-webkit-color-swatch-wrapper { padding: 0; }
        #colorPicker::-webkit-color-swatch { border: none; border-radius: 1.5rem; }
        #colorPicker::-moz-color-swatch-wrapper { padding: 0; }
        #colorPicker::-moz-color-swatch { border: none; border-radius: 1.5rem; }

        /* Custom style for the SELECTED effect button */
        .effect-button.selected {
            background-color: #10B981 !important; /* Tailwind green-500 */
            color: white !important;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3), 0 2px 4px -2px rgba(16, 185, 129, 0.3);
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-md bg-white p-6 md:p-8 rounded-2xl shadow-xl space-y-6">
        <h1 class="text-3xl font-bold text-center text-gray-800">Kleurkiezer voor Kerst</h1>
        <p class="text-center text-gray-500 mb-2">Selecteer een kleur en een effect om te verzenden.</p>

        <div id="activeStateDisplay" class="text-center text-sm p-3 rounded-xl font-medium bg-indigo-100 text-indigo-700 transition-all duration-500">
            Momenteel Actief: <strong>Wachten op data...</strong>
        </div>

        <div id="selectedEffectDisplay" class="text-center text-sm p-3 rounded-xl font-medium bg-blue-50 text-blue-700">
            Gekozen Effect: <strong>Static (9)</strong>
        </div>

        <div class="flex flex-col items-center space-y-4">
            <label for="colorPicker" class="text-lg font-medium text-gray-700">Gekozen Kleur:</label>
            <input type="color" id="colorPicker" value="#0056D6">
        </div>

        <div class="space-y-3 pt-2">
            <label class="text-lg font-medium text-gray-700 text-center block">Speciale Effecten (direct verzenden):</label>
            <div id="effectButtonsContainer" class="grid grid-cols-5 gap-2 md:gap-3">
            </div>
        </div>

        <div id="statusBox" class="text-center text-sm p-3 rounded-xl font-medium transition-all duration-300 bg-yellow-100 text-yellow-700">
            Verbinden met lampjes...
        </div>

        <button id="publishButton" disabled
                class="w-full py-4 text-lg font-semibold rounded-xl transition duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed
                       bg-blue-600 hover:bg-blue-700 text-white shadow-lg shadow-blue-500/50">
            Verzend Geselecteerd Kleur (Static 9)
        </button>

        <p class="text-xs text-center text-gray-400 pt-2">
            Broker: test.mosquitto.org (poort 8081, WSS) | Topic: joriskerst
        </p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <script>
        // --- Global MQTT Setup ---
        const host = "test.mosquitto.org";
        const port = 8081;
        const path = ""; 
        const topic = "joriskerst";
        
        // Generate a unique client ID
        const clientId = "web_color_picker_" + Math.random().toString(16).substr(2, 8);
        
        let client;
        
        // ***** MODIFIED: Global object to track the selected effect's number and name *****
        // Default is Static (9), but we don't need to select a button.
        let selectedEffect = {
            name: "Static", 
            number: 9
        }; 

        // ***** MODIFIED: Removed 'Static' from the button list *****
        // Static (9) is handled by the main publish button.
        const effectButtonLabels = [
            "Sparkle", "Fade", "Chase", "Blink", "Wave",
            "Cycle", "Strobe", "Twinkle", /* Static removed */ "Rainbow"
        ];
        
        // --- DOM Elements ---
        const statusBox = document.getElementById('statusBox');
        const publishButton = document.getElementById('publishButton');
        const colorPicker = document.getElementById('colorPicker');
        const effectButtonsContainer = document.getElementById('effectButtonsContainer');
        const selectedEffectDisplay = document.getElementById('selectedEffectDisplay');
        const activeStateDisplay = document.getElementById('activeStateDisplay');

        // --- UI & Utility Functions ---

        /**
         * Updates the status message displayed to the user.
         */
        function updateStatus(message, type = 'info') {
            statusBox.textContent = message;
            statusBox.classList.remove('bg-yellow-100', 'text-yellow-700', 'bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700');

            const allEffectButtons = document.querySelectorAll('.effect-button');

            switch (type) {
                case 'success':
                    statusBox.classList.add('bg-green-100', 'text-green-700');
                    publishButton.disabled = false;
                    allEffectButtons.forEach(btn => btn.disabled = false); 
                    break;
                case 'error':
                    statusBox.classList.add('bg-red-100', 'text-red-700');
                    publishButton.disabled = true;
                    allEffectButtons.forEach(btn => btn.disabled = true); 
                    break;
                case 'info':
                default:
                    statusBox.classList.add('bg-yellow-100', 'text-yellow-700');
                    publishButton.disabled = true;
                    allEffectButtons.forEach(btn => btn.disabled = true); 
                    break;
            }
        }
        
        /**
         * Creates the effect buttons dynamically.
         */
        function createEffectButtons() {
            effectButtonLabels.forEach((label, index) => {
                // The effects are now 1-8 and 10, skipping 9 (Static)
                let effectNumber = index + 1;
                
                // If we reach the index for 'Rainbow' (originally index 9, now index 8), assign 10.
                // The 'Static' button was at index 8 (number 9).
                if (label === "Rainbow") {
                    effectNumber = 10;
                }
                
                const button = document.createElement('button');
                button.type = 'button';
                button.textContent = `${label} (${effectNumber})`;
                button.dataset.effectName = label;
                button.dataset.effectNumber = effectNumber; // Store the actual number

                // No button is initially 'selected' (Static 9 is the default)
                button.className = `effect-button py-2 px-1 text-xs md:text-sm font-medium rounded-lg transition-all 
                                     bg-gray-100 text-gray-700 hover:bg-gray-200 
                                     disabled:opacity-50 disabled:cursor-not-allowed`;
                
                button.disabled = true;
                
                button.addEventListener('click', () => {
                    selectEffect(label, effectNumber);
                    publishCombinedMessage(effectNumber);
                });
                
                effectButtonsContainer.appendChild(button);
            });
        }

        /**
         * Selects an effect and updates the UI for the *chosen* effect.
         * Note: This function is now only called by the effect buttons, not the main button.
         */
        function selectEffect(name, number) {
            // 1. Update global object
            selectedEffect.name = name;
            selectedEffect.number = number;

            // 2. Update display
            selectedEffectDisplay.innerHTML = `Gekozen Effect: <strong>${name} (${number})</strong>`;

            // 3. Update button styles (Clear previous selection and set new one)
            const allEffectButtons = document.querySelectorAll('.effect-button');
            allEffectButtons.forEach(btn => {
                btn.classList.remove('selected');
                if (parseInt(btn.dataset.effectNumber) === number) {
                    btn.classList.add('selected');
                }
            });
        }
        
        // --- MQTT Functions (connection functions remain the same) ---
        
        function mqttConnect() {
            try {
                client = new Paho.MQTT.Client(host, port, path, clientId);
                client.onConnectionLost = onConnectionLost;
                client.onMessageArrived = onMessageArrived;
                
                updateStatus("Verbinden met lampjes...");
                client.connect({
                    onSuccess: onConnect,
                    onFailure: onFailure,
                    cleanSession: true,
                    useSSL: true, 
                });
            } catch (e) {
                console.error("MQTT Initialization Error:", e);
                updateStatus(`Fout bij initialisatie: ${e.message}`, 'error');
            }
        }

        function onConnect() {
            console.log("MQTT Connected");
            updateStatus("Verbinding gelukt! Klaar om te publiceren. Abonneren op topic...", 'success');
            
            // Subscribe to the topic when connected
            client.subscribe(topic, { qos: 0 });
            console.log(`Subscribed to topic: ${topic}`);
            
            // No need to call selectEffect here, as Static 9 is the default
        }

        function onFailure(responseObject) {
            console.error("MQTT Connection Failed:", responseObject);
            updateStatus(`Verbindingsfout: ${responseObject.errorMessage}. Opnieuw proberen in 5s.`, 'error');
            setTimeout(mqttConnect, 5000); 
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.error("MQTT Connection Lost:", responseObject.errorMessage);
                updateStatus(`Verbinding verbroken: ${responseObject.errorMessage}. Opnieuw proberen in 5s.`, 'error');
                setTimeout(mqttConnect, 5000);
            }
        }

        /**
         * Handles incoming MQTT messages and updates the active display
         */
        function onMessageArrived(message) {
            const payload = message.payloadString;
            console.log(`Message received on ${message.destinationName}: ${payload}`);

            if (payload && payload.includes(',')) {
                const parts = payload.split(',');
                const effectNum = parseInt(parts[0].trim());
                const hexColor = parts[1].trim();
                
                // Manually map number 9 back to the name 'Static'
                let effectName;
                if (effectNum >= 1 && effectNum <= 8) {
                    effectName = effectButtonLabels[effectNum - 1];
                } else if (effectNum === 9) {
                    effectName = "Static";
                } else if (effectNum === 10) {
                    effectName = "Rainbow"; // Index 8 in the new array
                } else {
                    effectName = "Onbekend";
                }

                // Update the active state display box
                activeStateDisplay.innerHTML = `
                    Momenteel Actief: 
                    <strong style="color: ${hexColor};">
                        ${effectName} (${effectNum})
                    </strong>
                    met kleur 
                    <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: ${hexColor}; border: 1px solid #ccc;"></span>
                    ${hexColor}
                `;
            } else {
                console.warn("Received message not in 'Number,#RRGGBB' format:", payload);
                activeStateDisplay.innerHTML = 'Momenteel Actief: <strong>Ongeldige data ontvangen</strong>';
            }
        }
        
        /**
         * Publishes the combined 'EffectNumber,#RRGGBB' message.
         */
        function publishCombinedMessage(effectNumberToPublish = selectedEffect.number) {
            if (!client || !client.isConnected()) {
                updateStatus("Niet verbonden. Opnieuw verbinding maken...", 'error');
                mqttConnect();
                return;
            }

            const hexValue = colorPicker.value.toUpperCase(); 
            // Create the combined payload: "EffectNumber,#RRGGBB"
            const payload = `${effectNumberToPublish},${hexValue}`;

            const message = new Paho.MQTT.Message(payload);
            message.destinationName = topic;
            message.qos = 0;
            message.retained = false; 

            try {
                client.send(message);
                updateStatus(`Bericht (${payload}) succesvol verzonden!`, 'success');
                console.log(`Published to ${topic}: ${payload}`);

                setTimeout(() => {
                    if (statusBox.textContent.includes("succesvol verzonden")) {
                        updateStatus("Verbinding gelukt! Klaar om te publiceren.", 'success');
                    }
                }, 2000);

            } catch (e) {
                console.error("MQTT Publish Error:", e);
                updateStatus(`Fout bij verzenden: ${e.message}`, 'error');
            }
        }

        // --- Event Listeners and Initialization ---
        
        // 1. Initialize the page when it loads
        window.onload = function() {
            createEffectButtons();
            mqttConnect();
        };

        // 2. Attach the combined publish function to the main button
        // When the main button is pressed, it uses the globally stored selectedEffect.number (default 9)
        publishButton.addEventListener('click', () => publishCombinedMessage(selectedEffect.number));

    </script>

</body>
</html>
