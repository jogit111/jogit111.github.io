<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kerstlichtjes Kleurkiezer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* Custom styling for the color input */
        #colorPicker {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background: none;
            border: none;
            width: 100%;
            height: 150px;
            cursor: pointer;
            border-radius: 1.5rem;
            padding: 0;
            overflow: hidden;
        }
        #colorPicker::-webkit-color-swatch-wrapper { padding: 0; }
        #colorPicker::-webkit-color-swatch { border: none; border-radius: 1.5rem; }
        #colorPicker::-moz-color-swatch-wrapper { padding: 0; }
        #colorPicker::-moz-color-swatch { border: none; border-radius: 1.5rem; }

        /* Custom style for the SELECTED effect button */
        .effect-button.selected {
            background-color: #10B981 !important; /* Tailwind green-500 */
            color: white !important;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3), 0 2px 4px -2px rgba(16, 185, 129, 0.3);
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-md bg-white p-6 md:p-8 rounded-2xl shadow-xl space-y-6">
        <h1 class="text-3xl font-bold text-center text-gray-800">Kleurkiezer voor Kerst</h1>
        <p class="text-center text-gray-500 mb-2">Selecteer een kleur en een effect. Klik een effect opnieuw om deze uit te schakelen.</p>

        <div id="activeStateDisplay" class="text-center text-sm p-3 rounded-xl font-medium bg-indigo-100 text-indigo-700 transition-all duration-500">
            Momenteel Actief: <strong>Wachten op data...</strong>
        </div>

        <div id="selectedEffectDisplay" class="text-center text-sm p-3 rounded-xl font-medium bg-blue-50 text-blue-700">
            Gekozen Effect: <strong>Static (9)</strong>
        </div>

        <div class="flex flex-col items-center space-y-4">
            <label for="colorPicker" class="text-lg font-medium text-gray-700">Gekozen Kleur:</label>
            <input type="color" id="colorPicker" value="#0056D6">
        </div>

        <div class="space-y-3 pt-2">
            <label class="text-lg font-medium text-gray-700 text-center block">Speciale Effecten (direct verzenden):</label>
            <div id="effectButtonsContainer" class="grid grid-cols-5 gap-2 md:gap-3">
            </div>
        </div>

        <div id="statusBox" class="text-center text-sm p-3 rounded-xl font-medium transition-all duration-300 bg-yellow-100 text-yellow-700">
            Verbinden met lampjes...
        </div>

        <button id="publishButton" disabled
                class="w-full py-4 text-lg font-semibold rounded-xl transition duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed
                       bg-blue-600 hover:bg-blue-700 text-white shadow-lg shadow-blue-500/50">
            Verzend Geselecteerde Kleur & Effect
        </button>

        <p class="text-xs text-center text-gray-400 pt-2">
            Broker: test.mosquitto.org (poort 8081, WSS) | Topics: joriskerst/effect & joriskerst/color
        </p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <script>
        // --- Global MQTT Setup ---
        const host = "test.mosquitto.org";
        const port = 8081;
        const path = ""; 
        const EFFECT_TOPIC = "joriskerst/effect";
        const COLOR_TOPIC = "joriskerst/color";
        const SUBSCRIBE_TOPIC = "joriskerst/#"; 
        
        const clientId = "web_color_picker_" + Math.random().toString(16).substr(2, 8);
        
        let client;
        
        // Define the Static (default) state
        const STATIC_EFFECT = {
            name: "Static",
            number: 9
        };

        // Global object to track the selected effect's number and name. Defaults to Static.
        let selectedEffect = STATIC_EFFECT; 

        // Global state tracking for received data 
        let activeState = {
            effect: STATIC_EFFECT,
            color: "#0056D6"
        };

        // Array mapping effect numbers back to names (for UI display)
        const effectButtonLabels = [
            "Sparkle", "Fade", "Chase", "Blink", "Wave",
            "Cycle", "Strobe", "Twinkle", /* Static removed */ "Rainbow"
        ];
        
        // --- DOM Elements ---
        const statusBox = document.getElementById('statusBox');
        const publishButton = document.getElementById('publishButton');
        const colorPicker = document.getElementById('colorPicker');
        const effectButtonsContainer = document.getElementById('effectButtonsContainer');
        const selectedEffectDisplay = document.getElementById('selectedEffectDisplay');
        const activeStateDisplay = document.getElementById('activeStateDisplay');

        // --- UI & Utility Functions ---

        /**
         * Updates the status message displayed to the user.
         */
        function updateStatus(message, type = 'info') {
            statusBox.textContent = message;
            statusBox.classList.remove('bg-yellow-100', 'text-yellow-700', 'bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700');

            const allEffectButtons = document.querySelectorAll('.effect-button');

            switch (type) {
                case 'success':
                    statusBox.classList.add('bg-green-100', 'text-green-700');
                    publishButton.disabled = false;
                    allEffectButtons.forEach(btn => btn.disabled = false); 
                    break;
                case 'error':
                    statusBox.classList.add('bg-red-100', 'text-red-700');
                    publishButton.disabled = true;
                    allEffectButtons.forEach(btn => btn.disabled = true); 
                    break;
                case 'info':
                default:
                    statusBox.classList.add('bg-yellow-100', 'text-yellow-700');
                    publishButton.disabled = true;
                    allEffectButtons.forEach(btn => btn.disabled = true); 
                    break;
            }
        }

        /**
         * Looks up effect name by number.
         * @param {number} num - The effect number (1-10).
         * @returns {string} The effect name.
         */
        function getEffectName(num) {
            if (num >= 1 && num <= 8) {
                return effectButtonLabels[num - 1];
            } else if (num === 9) {
                return STATIC_EFFECT.name;
            } else if (num === 10) {
                return "Rainbow";
            }
            return "Onbekend";
        }
        
        /**
         * Creates the effect buttons dynamically.
         */
        function createEffectButtons() {
            effectButtonLabels.forEach((label, index) => {
                let effectNumber = index + 1;
                
                if (label === "Rainbow") {
                    effectNumber = 10;
                }
                
                const button = document.createElement('button');
                button.type = 'button';
                button.textContent = `${label} (${effectNumber})`;
                button.dataset.effectName = label;
                button.dataset.effectNumber = effectNumber;

                button.className = `effect-button py-2 px-1 text-xs md:text-sm font-medium rounded-lg transition-all 
                                     bg-gray-100 text-gray-700 hover:bg-gray-200 
                                     disabled:opacity-50 disabled:cursor-not-allowed`;
                
                button.disabled = true;
                
                // ***** MODIFIED: Toggle logic on click *****
                button.addEventListener('click', function() {
                    const currentNum = parseInt(this.dataset.effectNumber);
                    const currentName = this.dataset.effectName;

                    if (selectedEffect.number === currentNum) {
                        // If already selected, UNSELECT it (revert to Static)
                        selectEffect(STATIC_EFFECT.name, STATIC_EFFECT.number);
                        publishEffect(STATIC_EFFECT.number);
                    } else {
                        // If not selected, SELECT it
                        selectEffect(currentName, currentNum);
                        publishEffect(currentNum);
                    }
                });
                
                effectButtonsContainer.appendChild(button);
            });
        }

        /**
         * Selects an effect and updates the UI for the *chosen* effect.
         */
        function selectEffect(name, number) {
            // 1. Update global object
            selectedEffect.name = name;
            selectedEffect.number = number;

            // 2. Update display
            selectedEffectDisplay.innerHTML = `Gekozen Effect: <strong>${name} (${number})</strong>`;

            // 3. Update button styles (highlight only if NOT static)
            const allEffectButtons = document.querySelectorAll('.effect-button');
            allEffectButtons.forEach(btn => {
                const btnNum = parseInt(btn.dataset.effectNumber);
                btn.classList.remove('selected');
                
                if (number === btnNum) {
                    // Only highlight if the selected effect is one of the buttons
                    btn.classList.add('selected');
                }
            });
        }
        
        // --- MQTT Connection Functions (no change) ---
        
        function mqttConnect() {
            try {
                client = new Paho.MQTT.Client(host, port, path, clientId);
                client.onConnectionLost = onConnectionLost;
                client.onMessageArrived = onMessageArrived;
                
                updateStatus("Verbinden met lampjes...");
                client.connect({
                    onSuccess: onConnect,
                    onFailure: onFailure,
                    cleanSession: true,
                    useSSL: true, 
                });
            } catch (e) {
                console.error("MQTT Initialization Error:", e);
                updateStatus(`Fout bij initialisatie: ${e.message}`, 'error');
            }
        }

        function onConnect() {
            console.log("MQTT Connected");
            updateStatus("Verbinding gelukt! Klaar om te publiceren. Abonneren op updates...", 'success');
            
            client.subscribe(SUBSCRIBE_TOPIC, { qos: 0 });
            console.log(`Subscribed to topic: ${SUBSCRIBE_TOPIC}`);
            
            // Ensure the correct default state is shown on connect
            selectEffect(selectedEffect.name, selectedEffect.number);
        }

        function onFailure(responseObject) {
            console.error("MQTT Connection Failed:", responseObject);
            updateStatus(`Verbindingsfout: ${responseObject.errorMessage}. Opnieuw proberen in 5s.`, 'error');
            setTimeout(mqttConnect, 5000); 
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.error("MQTT Connection Lost:", responseObject.errorMessage);
                updateStatus(`Verbinding verbroken: ${responseObject.errorMessage}. Opnieuw proberen in 5s.`, 'error');
                setTimeout(mqttConnect, 5000);
            }
        }

        /**
         * Handles incoming MQTT messages and updates the active display
         */
        function onMessageArrived(message) {
            const payload = message.payloadString.trim();
            const topic = message.destinationName.toLowerCase();
            console.log(`Message received on ${topic}: ${payload}`);

            if (topic === EFFECT_TOPIC.toLowerCase()) {
                const effectNum = parseInt(payload);
                if (!isNaN(effectNum)) {
                    activeState.effect.number = effectNum;
                    activeState.effect.name = getEffectName(effectNum);
                }
            } else if (topic === COLOR_TOPIC.toLowerCase()) {
                if (payload.startsWith('#') && payload.length === 7) {
                    activeState.color = payload;
                }
            }
            
            updateActiveStateDisplay();
        }

        /**
         * Updates the active state display using the globally tracked activeState object.
         */
        function updateActiveStateDisplay() {
            const name = activeState.effect.name;
            const num = activeState.effect.number;
            const color = activeState.color;

            activeStateDisplay.innerHTML = `
                Momenteel Actief: 
                <strong style="color: ${color};">
                    ${name} (${num})
                </strong>
                met kleur 
                <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: ${color}; border: 1px solid #ccc;"></span>
                ${color}
            `;
        }

        /**
         * Publishes the effect number to the effect topic.
         */
        function publishEffect(effectNumberToPublish = selectedEffect.number) {
            if (!client || !client.isConnected()) {
                updateStatus("Niet verbonden. Opnieuw verbinding maken...", 'error');
                mqttConnect();
                return;
            }

            const payload = effectNumberToPublish.toString();
            const message = new Paho.MQTT.Message(payload);
            message.destinationName = EFFECT_TOPIC;
            message.qos = 0;
            message.retained = false; 

            try {
                client.send(message);
                updateStatus(`Effect (${payload}) succesvol verzonden!`, 'success');
                console.log(`Published to ${EFFECT_TOPIC}: ${payload}`);

                setTimeout(() => {
                    if (statusBox.textContent.includes("succesvol verzonden")) {
                        updateStatus("Verbinding gelukt! Klaar om te publiceren.", 'success');
                    }
                }, 2000);

            } catch (e) {
                console.error("MQTT Publish Error:", e);
                updateStatus(`Fout bij verzenden: ${e.message}`, 'error');
            }
        }

        /**
         * Publishes the color hex value to the color topic.
         */
        function publishColor() {
             if (!client || !client.isConnected()) {
                updateStatus("Niet verbonden. Opnieuw verbinding maken...", 'error');
                mqttConnect();
                return;
            }

            const hexValue = colorPicker.value.toUpperCase(); 
            const payload = hexValue;

            const message = new Paho.MQTT.Message(payload);
            message.destinationName = COLOR_TOPIC;
            message.qos = 0;
            message.retained = false; 

            try {
                client.send(message);
                updateStatus(`Kleur (${payload}) succesvol verzonden!`, 'success');
                console.log(`Published to ${COLOR_TOPIC}: ${payload}`);

                setTimeout(() => {
                    if (statusBox.textContent.includes("succesvol verzonden")) {
                        updateStatus("Verbinding gelukt! Klaar om te publiceren.", 'success');
                    }
                }, 2000);

            } catch (e) {
                console.error("MQTT Publish Error:", e);
                updateStatus(`Fout bij verzenden: ${e.message}`, 'error');
            }
        }

        // --- Event Listeners and Initialization ---
        
        // 1. Initialize the page when it loads
        window.onload = function() {
            createEffectButtons();
            mqttConnect();
            updateActiveStateDisplay(); // Show initial default state
        };

        // 2. Attach the publish functions to the main button
        publishButton.addEventListener('click', () => {
            // Publishes the currently selected effect (which may be 9/Static) AND the color.
            publishEffect(selectedEffect.number);
            publishColor();
        });

        // 3. Optional: Publish color immediately when the color picker changes
        colorPicker.addEventListener('change', publishColor);

    </script>

</body>
</html>
